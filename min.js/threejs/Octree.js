!function(t){"use strict";function e(t){return!isNaN(t)&&isFinite(t)}function s(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(t){return t?!0!==s(t)?[t]:t:[]}function o(t,e){for(var s=0,i=t.length;s<i;s++)if(t[s]===e)return s;return-1}function n(t,e,s){for(var i=0,o=t.length;i<o;i++)if(t[i][e]===s)return i;return-1}t.Octree=function(s){(s=s||{}).tree=this,this.nodeCount=0,this.INDEX_INSIDE_CROSS=-1,this.INDEX_OUTSIDE_OFFSET=2,this.INDEX_OUTSIDE_POS_X=e(s.INDEX_OUTSIDE_POS_X)?s.INDEX_OUTSIDE_POS_X:0,this.INDEX_OUTSIDE_NEG_X=e(s.INDEX_OUTSIDE_NEG_X)?s.INDEX_OUTSIDE_NEG_X:1,this.INDEX_OUTSIDE_POS_Y=e(s.INDEX_OUTSIDE_POS_Y)?s.INDEX_OUTSIDE_POS_Y:2,this.INDEX_OUTSIDE_NEG_Y=e(s.INDEX_OUTSIDE_NEG_Y)?s.INDEX_OUTSIDE_NEG_Y:3,this.INDEX_OUTSIDE_POS_Z=e(s.INDEX_OUTSIDE_POS_Z)?s.INDEX_OUTSIDE_POS_Z:4,this.INDEX_OUTSIDE_NEG_Z=e(s.INDEX_OUTSIDE_NEG_Z)?s.INDEX_OUTSIDE_NEG_Z:5,this.INDEX_OUTSIDE_MAP=[],this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_X]={index:this.INDEX_OUTSIDE_POS_X,count:0,x:1,y:0,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_X]={index:this.INDEX_OUTSIDE_NEG_X,count:0,x:-1,y:0,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Y]={index:this.INDEX_OUTSIDE_POS_Y,count:0,x:0,y:1,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Y]={index:this.INDEX_OUTSIDE_NEG_Y,count:0,x:0,y:-1,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Z]={index:this.INDEX_OUTSIDE_POS_Z,count:0,x:0,y:0,z:1},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Z]={index:this.INDEX_OUTSIDE_NEG_Z,count:0,x:0,y:0,z:-1},this.FLAG_POS_X=1<<this.INDEX_OUTSIDE_POS_X+1,this.FLAG_NEG_X=1<<this.INDEX_OUTSIDE_NEG_X+1,this.FLAG_POS_Y=1<<this.INDEX_OUTSIDE_POS_Y+1,this.FLAG_NEG_Y=1<<this.INDEX_OUTSIDE_NEG_Y+1,this.FLAG_POS_Z=1<<this.INDEX_OUTSIDE_POS_Z+1,this.FLAG_NEG_Z=1<<this.INDEX_OUTSIDE_NEG_Z+1,this.utilVec31Search=new t.Vector3,this.utilVec32Search=new t.Vector3,this.scene=s.scene,this.scene&&(this.visualGeometry=new t.BoxGeometry(1,1,1),this.visualMaterial=new t.MeshBasicMaterial({color:16711782,wireframe:!0,wireframeLinewidth:1})),this.objects=[],this.objectsMap={},this.objectsData=[],this.objectsDeferred=[],this.depthMax=e(s.depthMax)?s.depthMax:1/0,this.objectsThreshold=e(s.objectsThreshold)?s.objectsThreshold:8,this.overlapPct=e(s.overlapPct)?s.overlapPct:.15,this.undeferred=s.undeferred||!1,this.root=s.root instanceof t.OctreeNode?s.root:new t.OctreeNode(s)},t.Octree.prototype={update:function(){if(this.objectsDeferred.length>0){for(var t=0,e=this.objectsDeferred.length;t<e;t++){var s=this.objectsDeferred[t];this.addDeferred(s.object,s.options)}this.objectsDeferred.length=0}},add:function(t,e){this.undeferred?(this.updateObject(t),this.addDeferred(t,e)):this.objectsDeferred.push({object:t,options:e})},addDeferred:function(e,s){var i,o,n,h,r,c;if(e instanceof t.OctreeObjectData&&(e=e.object),e.uuid||(e.uuid=t.Math.generateUUID()),!this.objectsMap[e.uuid])if(this.objects.push(e),this.objectsMap[e.uuid]=e,s&&(h=s.useFaces,c=s.useVertices),!0===c)for(i=0,o=(r=e.geometry.vertices).length;i<o;i++)this.addObjectData(e,r[i]);else if(!0===h)for(i=0,o=(n=e.geometry.faces).length;i<o;i++)this.addObjectData(e,n[i]);else this.addObjectData(e)},addObjectData:function(e,s){var i=new t.OctreeObjectData(e,s);this.objectsData.push(i),this.root.addObject(i)},remove:function(e){var s,i,h,r,c=e;if(e instanceof t.OctreeObjectData&&(e=e.object),this.objectsMap[e.uuid]){if(this.objectsMap[e.uuid]=void 0,-1!==(h=o(this.objects,e)))for(this.objects.splice(h,1),s=0,i=(r=this.root.removeObject(c)).length;s<i;s++)c=r[s],-1!==(h=o(this.objectsData,c))&&this.objectsData.splice(h,1)}else this.objectsDeferred.length>0&&-1!==(h=n(this.objectsDeferred,"object",e))&&this.objectsDeferred.splice(h,1)},extend:function(e){var s,i,o,n;if(e instanceof t.Octree)for(s=0,i=(o=e.objectsData).length;s<i;s++)n=o[s],this.add(n,{useFaces:n.faces,useVertices:n.vertices})},rebuild:function(){var e,s,i,o,n,h=[];for(e=0,s=this.objectsData.length;e<s;e++)i=(o=this.objectsData[e]).node,o.update(),i instanceof t.OctreeNode&&!o.positionLast.equals(o.position)&&(n=o.indexOctant,i.getOctantIndex(o)!==n&&h.push(o));for(e=0,s=h.length;e<s;e++)(o=h[e]).node.removeObject(o),this.root.addObject(o)},updateObject:function(t){var e,s,i,o,n=[t];for(i=t.parent;i;)n.push(i),i=i.parent;for(e=0,s=n.length;e<s;e++)!0===(i=n[e]).matrixWorldNeedsUpdate&&(o=i);void 0!==o&&o.updateMatrixWorld()},search:function(e,s,i,n){var h,r,c,a,d,u,O,p,_,f;for(c=[].concat(this.root.objects),s>0||(s=Number.MAX_VALUE),n instanceof t.Vector3&&(n=this.utilVec31Search.copy(n).normalize(),f=this.utilVec32Search.set(1,1,1).divide(n)),h=0,r=this.root.nodesIndices.length;h<r;h++)c=this.root.nodesByIndex[this.root.nodesIndices[h]].search(e,s,c,n,f);if(!0===i)for(u=[],p=[],h=0,r=c.length;h<r;h++)-1===(_=o(p,d=(a=c[h]).object))?(O={object:d,faces:[],vertices:[]},u.push(O),p.push(d)):O=u[_],a.faces?O.faces.push(a.faces):a.vertices&&O.vertices.push(a.vertices);else u=c;return u},setRoot:function(e){e instanceof t.OctreeNode&&(this.root=e,this.root.updateProperties())},getDepthEnd:function(){return this.root.getDepthEnd()},getNodeCountEnd:function(){return this.root.getNodeCountEnd()},getObjectCountEnd:function(){return this.root.getObjectCountEnd()},toConsole:function(){this.root.toConsole()}},t.OctreeObjectData=function(e,s){this.object=e,s instanceof t.Face3?(this.faces=s,this.face3=!0,this.utilVec31FaceBounds=new t.Vector3):s instanceof t.Vector3&&(this.vertices=s),this.radius=0,this.position=new t.Vector3,this.object instanceof t.Object3D&&this.update(),this.positionLast=this.position.clone()},t.OctreeObjectData.prototype={update:function(){this.face3?(this.radius=this.getFace3BoundingRadius(this.object,this.faces),this.position.copy(this.faces.centroid).applyMatrix4(this.object.matrixWorld)):this.vertices?(this.radius=this.object.material.size||1,this.position.copy(this.vertices).applyMatrix4(this.object.matrixWorld)):this.object.geometry?(null===this.object.geometry.boundingSphere&&this.object.geometry.computeBoundingSphere(),this.radius=this.object.geometry.boundingSphere.radius,this.position.copy(this.object.geometry.boundingSphere.center).applyMatrix4(this.object.matrixWorld)):(this.radius=this.object.boundRadius,this.position.setFromMatrixPosition(this.object.matrixWorld)),this.radius=this.radius*Math.max(this.object.scale.x,this.object.scale.y,this.object.scale.z)},getFace3BoundingRadius:function(e,s){void 0===s.centroid&&(s.centroid=new t.Vector3);var i=(e.geometry||e).vertices,o=s.centroid,n=i[s.a],h=i[s.b],r=i[s.c],c=this.utilVec31FaceBounds;return o.addVectors(n,h).add(r).divideScalar(3),Math.max(c.subVectors(o,n).length(),c.subVectors(o,h).length(),c.subVectors(o,r).length())}},t.OctreeNode=function(e){this.utilVec31Branch=new t.Vector3,this.utilVec31Expand=new t.Vector3,this.utilVec31Ray=new t.Vector3,(e=e||{}).tree instanceof t.Octree?this.tree=e.tree:e.parent instanceof t.OctreeNode!=!0&&(e.root=this,this.tree=new t.Octree(e)),this.id=this.tree.nodeCount++,this.position=e.position instanceof t.Vector3?e.position:new t.Vector3,this.radius=e.radius>0?e.radius:1,this.indexOctant=e.indexOctant,this.depth=0,this.reset(),this.setParent(e.parent),this.overlap=this.radius*this.tree.overlapPct,this.radiusOverlap=this.radius+this.overlap,this.left=this.position.x-this.radiusOverlap,this.right=this.position.x+this.radiusOverlap,this.bottom=this.position.y-this.radiusOverlap,this.top=this.position.y+this.radiusOverlap,this.back=this.position.z-this.radiusOverlap,this.front=this.position.z+this.radiusOverlap,this.tree.scene&&(this.visual=new t.Mesh(this.tree.visualGeometry,this.tree.visualMaterial),this.visual.scale.set(2*this.radiusOverlap,2*this.radiusOverlap,2*this.radiusOverlap),this.visual.position.copy(this.position),this.tree.scene.add(this.visual))},t.OctreeNode.prototype={setParent:function(t){t!==this&&this.parent!==t&&(this.parent=t,this.updateProperties())},updateProperties:function(){var e,s;for(this.parent instanceof t.OctreeNode?(this.tree=this.parent.tree,this.depth=this.parent.depth+1):this.depth=0,e=0,s=this.nodesIndices.length;e<s;e++)this.nodesByIndex[this.nodesIndices[e]].updateProperties()},reset:function(t,e){var s,i,o,n=this.nodesIndices||[],h=this.nodesByIndex;for(this.objects=[],this.nodesIndices=[],this.nodesByIndex={},s=0,i=n.length;s<i;s++)(o=h[n[s]]).setParent(void 0),!0===t&&o.reset(t,e);!0===e&&this.visual&&this.visual.parent&&this.visual.parent.remove(this.visual)},addNode:function(t,e){t.indexOctant=e,-1===o(this.nodesIndices,e)&&this.nodesIndices.push(e),this.nodesByIndex[e]=t,t.parent!==this&&t.setParent(this)},removeNode:function(t){var e,s;e=o(this.nodesIndices,t),this.nodesIndices.splice(e,1),s=s||this.nodesByIndex[t],delete this.nodesByIndex[t],s.parent===this&&s.setParent(void 0)},addObject:function(e){var s;(s=this.getOctantIndex(e))>-1&&this.nodesIndices.length>0?this.branch(s).addObject(e):s<-1&&this.parent instanceof t.OctreeNode?this.parent.addObject(e):(-1===o(this.objects,e)&&this.objects.push(e),e.node=this,this.checkGrow())},addObjectWithoutCheck:function(t){var e,s,i;for(e=0,s=t.length;e<s;e++)i=t[e],this.objects.push(i),i.node=this},removeObject:function(t){var e,s,i,o;if(o=this.removeObjectRecursive(t,{searchComplete:!1,nodesRemovedFrom:[],objectsDataRemoved:[]}),(i=o.nodesRemovedFrom).length>0)for(e=0,s=i.length;e<s;e++)i[e].shrink();return o.objectsDataRemoved},removeObjectRecursive:function(e,s){var i,n,h,r,c,a=-1;if(e instanceof t.OctreeObjectData)-1!==(a=o(this.objects,e))&&(this.objects.splice(a,1),e.node=void 0,s.objectsDataRemoved.push(e),s.searchComplete=c=!0);else for(i=this.objects.length-1;i>=0;i--)if((h=this.objects[i]).object===e&&(this.objects.splice(i,1),h.node=void 0,s.objectsDataRemoved.push(h),c=!0,!h.faces&&!h.vertices)){s.searchComplete=!0;break}if(!0===c&&s.nodesRemovedFrom.push(this),!0!==s.searchComplete)for(i=0,n=this.nodesIndices.length;i<n&&(r=this.nodesByIndex[this.nodesIndices[i]],!0!==(s=r.removeObjectRecursive(e,s)).searchComplete);i++);return s},checkGrow:function(){this.objects.length>this.tree.objectsThreshold&&this.tree.objectsThreshold>0&&this.grow()},grow:function(){var t,e,s,i,o=[],n=[],h=[],r=[],c=[];for(s=0,i=this.objects.length;s<i;s++)e=this.objects[s],(t=this.getOctantIndex(e))>-1?(h.push(e),r.push(t)):t<-1?(o.push(e),n.push(t)):c.push(e);h.length>0&&(c=c.concat(this.split(h,r))),o.length>0&&(c=c.concat(this.expand(o,n))),this.objects=c,this.checkMerge()},split:function(t,e){var s,i,o,n,h;if(this.depth<this.tree.depthMax){for(t=t||this.objects,e=e||[],h=[],s=0,i=t.length;s<i;s++)n=t[s],(o=e[s])>-1?this.branch(o).addObject(n):h.push(n);t===this.objects&&(this.objects=h)}else h=this.objects;return h},branch:function(e){var s,i,o,n,h;return this.nodesByIndex[e]instanceof t.OctreeNode?s=this.nodesByIndex[e]:(o=(i=.5*this.radiusOverlap)-i*this.tree.overlapPct,n=this.utilVec31Branch.set(1&e?o:-o,2&e?o:-o,4&e?o:-o),h=(new t.Vector3).addVectors(this.position,n),s=new t.OctreeNode({tree:this.tree,parent:this,position:h,radius:i,indexOctant:e}),this.addNode(s,e)),s},expand:function(e,s){var i,o,n,h,r,c,a,d,u,O,p,_,f,l,I,E,b,D,j,N,g,v,S,x,X,y,m,T,P=this.tree.INDEX_OUTSIDE_MAP,U=this.utilVec31Expand;if(this.tree.root.getDepthEnd()<this.tree.depthMax){for(e=e||this.objects,s=s||[],h=[],r=[],i=0,o=P.length;i<o;i++)P[i].count=0;for(i=0,o=e.length;i<o;i++)n=e[i],(c=s[i])<-1?((a=-c-this.tree.INDEX_OUTSIDE_OFFSET)&this.tree.FLAG_POS_X?P[this.tree.INDEX_OUTSIDE_POS_X].count++:a&this.tree.FLAG_NEG_X&&P[this.tree.INDEX_OUTSIDE_NEG_X].count++,a&this.tree.FLAG_POS_Y?P[this.tree.INDEX_OUTSIDE_POS_Y].count++:a&this.tree.FLAG_NEG_Y&&P[this.tree.INDEX_OUTSIDE_NEG_Y].count++,a&this.tree.FLAG_POS_Z?P[this.tree.INDEX_OUTSIDE_POS_Z].count++:a&this.tree.FLAG_NEG_Z&&P[this.tree.INDEX_OUTSIDE_NEG_Z].count++,r.push(n)):h.push(n);if(r.length>0)for((u=P.slice(0)).sort(function(t,e){return e.count-t.count}),f=1|(O=u[0]).index,I=u[1],E=u[2],l=1|(p=(1|I.index)!==f?I:E).index,I=u[2],E=u[3],b=u[4],D=1|I.index,j=1|E.index,_=D!==f&&D!==l?I:j!==f&&j!==l?E:b,N=O.x+p.x+_.x,g=O.y+p.y+_.y,v=O.z+p.z+_.z,c=this.getOctantIndexFromPosition(N,g,v),d=this.getOctantIndexFromPosition(-N,-g,-v),S=this.overlap,x=this.radius,X=(y=this.tree.overlapPct>0?S/(.5*this.tree.overlapPct*(1+this.tree.overlapPct)):2*x)+y*this.tree.overlapPct-(x+S),U.set(1&c?X:-X,2&c?X:-X,4&c?X:-X),m=(new t.Vector3).addVectors(this.position,U),(T=new t.OctreeNode({tree:this.tree,position:m,radius:y})).addNode(this,d),this.tree.setRoot(T),i=0,o=r.length;i<o;i++)this.tree.root.addObject(r[i]);e===this.objects&&(this.objects=h)}else h=e;return h},shrink:function(){this.checkMerge(),this.tree.root.checkContract()},checkMerge:function(){for(var e,s=this;s.parent instanceof t.OctreeNode&&s.getObjectCountEnd()<this.tree.objectsThreshold;)e=s,s=s.parent;s!==this&&s.merge(e)},merge:function(t){var e,s,o;for(e=0,s=(t=i(t)).length;e<s;e++)o=t[e],this.addObjectWithoutCheck(o.getObjectsEnd()),o.reset(!0,!0),this.removeNode(o.indexOctant,o);this.checkMerge()},checkContract:function(){var e,s,i,o,n,h,r;if(this.nodesIndices.length>0){for(h=0,r=this.objects.length,e=0,s=this.nodesIndices.length;e<s;e++)r+=o=(i=this.nodesByIndex[this.nodesIndices[e]]).getObjectCountEnd(),(n instanceof t.OctreeNode==!1||o>h)&&(n=i,h=o);(r-=h)<this.tree.objectsThreshold&&n instanceof t.OctreeNode&&this.contract(n)}},contract:function(t){var e,s,i;for(e=0,s=this.nodesIndices.length;e<s;e++)(i=this.nodesByIndex[this.nodesIndices[e]])!==t&&(t.addObjectWithoutCheck(i.getObjectsEnd()),i.reset(!0,!0));t.addObjectWithoutCheck(this.objects),this.reset(!1,!0),this.tree.setRoot(t),t.checkContract()},getOctantIndex:function(e){var s,i,o,n,h,r,c,a,d=this.position,u=this.radiusOverlap,O=this.overlap,p=0;if(e instanceof t.OctreeObjectData?(i=e.radius,s=e.position,e.positionLast.copy(s)):e instanceof t.OctreeNode&&(s=e.position,i=0),o=s.x-d.x,n=s.y-d.y,h=s.z-d.z,r=Math.abs(o),c=Math.abs(n),a=Math.abs(h),Math.max(r,c,a)+i>u)return r+i>u&&(p^=o>0?this.tree.FLAG_POS_X:this.tree.FLAG_NEG_X),c+i>u&&(p^=n>0?this.tree.FLAG_POS_Y:this.tree.FLAG_NEG_Y),a+i>u&&(p^=h>0?this.tree.FLAG_POS_Z:this.tree.FLAG_NEG_Z),e.indexOctant=-p-this.tree.INDEX_OUTSIDE_OFFSET,e.indexOctant;if(o-i>-O)p|=1;else if(!(o+i<O))return e.indexOctant=this.tree.INDEX_INSIDE_CROSS,e.indexOctant;if(n-i>-O)p|=2;else if(!(n+i<O))return e.indexOctant=this.tree.INDEX_INSIDE_CROSS,e.indexOctant;if(h-i>-O)p|=4;else if(!(h+i<O))return e.indexOctant=this.tree.INDEX_INSIDE_CROSS,e.indexOctant;return e.indexOctant=p,e.indexOctant},getOctantIndexFromPosition:function(t,e,s){var i=0;return t>0&&(i|=1),e>0&&(i|=2),s>0&&(i|=4),i},search:function(t,e,s,i,o){var n,h;if(!0===(i?this.intersectRay(t,i,e,o):this.intersectSphere(t,e)))for(s=s.concat(this.objects),n=0,h=this.nodesIndices.length;n<h;n++)s=this.nodesByIndex[this.nodesIndices[n]].search(t,e,s,i);return s},intersectSphere:function(t,e){var s=e*e,i=t.x,o=t.y,n=t.z;return i<this.left?s-=Math.pow(i-this.left,2):i>this.right&&(s-=Math.pow(i-this.right,2)),o<this.bottom?s-=Math.pow(o-this.bottom,2):o>this.top&&(s-=Math.pow(o-this.top,2)),n<this.back?s-=Math.pow(n-this.back,2):n>this.front&&(s-=Math.pow(n-this.front,2)),s>=0},intersectRay:function(t,e,s,i){void 0===i&&(i=this.utilVec31Ray.set(1,1,1).divide(e));var o,n=(this.left-t.x)*i.x,h=(this.right-t.x)*i.x,r=(this.bottom-t.y)*i.y,c=(this.top-t.y)*i.y,a=(this.back-t.z)*i.z,d=(this.front-t.z)*i.z,u=Math.min(Math.min(Math.max(n,h),Math.max(r,c)),Math.max(a,d));return!(u<0)&&!((o=Math.max(Math.max(Math.min(n,h),Math.min(r,c)),Math.min(a,d)))>u||o>s)},getDepthEnd:function(t){var e,s;if(this.nodesIndices.length>0)for(e=0,s=this.nodesIndices.length;e<s;e++)t=this.nodesByIndex[this.nodesIndices[e]].getDepthEnd(t);else t=!t||this.depth>t?this.depth:t;return t},getNodeCountEnd:function(){return this.tree.root.getNodeCountRecursive()+1},getNodeCountRecursive:function(){var t,e,s=this.nodesIndices.length;for(t=0,e=this.nodesIndices.length;t<e;t++)s+=this.nodesByIndex[this.nodesIndices[t]].getNodeCountRecursive();return s},getObjectsEnd:function(t){var e,s;for(t=(t||[]).concat(this.objects),e=0,s=this.nodesIndices.length;e<s;e++)t=this.nodesByIndex[this.nodesIndices[e]].getObjectsEnd(t);return t},getObjectCountEnd:function(){var t,e,s=this.objects.length;for(t=0,e=this.nodesIndices.length;t<e;t++)s+=this.nodesByIndex[this.nodesIndices[t]].getObjectCountEnd();return s},getObjectCountStart:function(){for(var e=this.objects.length,s=this.parent;s instanceof t.OctreeNode;)e+=s.objects.length,s=s.parent;return e},toConsole:function(t){var e,s;for(t="string"==typeof t?t:"   ",console.log(this.parent?t+" octree NODE > ":" octree ROOT > ",this," // id: ",this.id," // indexOctant: ",this.indexOctant," // position: ",this.position.x,this.position.y,this.position.z," // radius: ",this.radius," // depth: ",this.depth),console.log(this.parent?t+" ":" ","+ objects ( ",this.objects.length," ) ",this.objects),console.log(this.parent?t+" ":" ","+ children ( ",this.nodesIndices.length," )",this.nodesIndices,this.nodesByIndex),e=0,s=this.nodesIndices.length;e<s;e++)this.nodesByIndex[this.nodesIndices[e]].toConsole(t+"   ")}},t.Raycaster.prototype.intersectOctreeObject=function(e,s){var i,o,n,h;return e.object instanceof t.Object3D?(e=(o=e).object,h=o.faces,n=e.geometry.faces,h.length>0&&(e.geometry.faces=h),i=this.intersectObject(e,s),h.length>0&&(e.geometry.faces=n)):i=this.intersectObject(e,s),i},t.Raycaster.prototype.intersectOctreeObjects=function(t,e){var s,i,o=[];for(s=0,i=t.length;s<i;s++)o=o.concat(this.intersectOctreeObject(t[s],e));return o}}(THREE);
//# sourceMappingURL=../maps/threejs/Octree.js.map
