THREE.MMDPhysics=function(t,e){this.mesh=t,this.helper=new THREE.MMDPhysics.PhysicsHelper,this.unitStep=e&&e.unitStep?e.unitStep:1/65,this.maxStepNum=e&&e.maxStepNum?e.maxStepNum:3,this.world=null,this.bodies=[],this.constraints=[],this.init()},THREE.MMDPhysics.prototype={constructor:THREE.MMDPhysics,init:function(){this.initWorld(),this.initRigidBodies(),this.initConstraints(),this.reset()},initWorld:function(){var t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),r=new Ammo.btDbvtBroadphase,i=new Ammo.btSequentialImpulseConstraintSolver,o=new Ammo.btDiscreteDynamicsWorld(e,r,i,t);o.setGravity(new Ammo.btVector3(0,-100,0)),this.world=o},initRigidBodies:function(){for(var t=this.mesh.geometry.rigidBodies,e=0;e<t.length;e++){var r=new THREE.MMDPhysics.RigidBody(this.mesh,this.world,t[e],this.helper);this.bodies.push(r)}},initConstraints:function(){for(var t=this.mesh.geometry.constraints,e=0;e<t.length;e++){var r=t[e],i=this.bodies[r.rigidBodyIndex1],o=this.bodies[r.rigidBodyIndex2],s=new THREE.MMDPhysics.Constraint(this.mesh,this.world,i,o,r,this.helper);this.constraints.push(s)}},update:function(t){var e=this.unitStep,r=t,i=1+(t/e|0);i>this.maxStepNum&&(i=this.maxStepNum),this.updateRigidBodies(),this.world.stepSimulation(r,i,e),this.updateBones()},updateRigidBodies:function(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].updateFromBone()},updateBones:function(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].updateBone()},reset:function(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].reset()},warmup:function(t){for(var e=0;e<t;e++)this.update(1)}},THREE.MMDPhysics.PhysicsHelper=function(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.transforms=[],this.quaternions=[],this.vector3s=[]},THREE.MMDPhysics.PhysicsHelper.prototype={allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new THREE.Vector3},freeThreeVector3:function(t){this.threeVector3s.push(t)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new THREE.Matrix4},freeThreeMatrix4:function(t){this.threeMatrix4s.push(t)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new THREE.Quaternion},freeThreeQuaternion:function(t){this.threeQuaternions.push(t)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(t){this.transforms.push(t)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(t){this.quaternions.push(t)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(t){this.vector3s.push(t)},setIdentity:function(t){t.setIdentity()},getBasis:function(t){var e=this.allocQuaternion();return t.getBasis().getRotation(e),e},getBasisAsMatrix3:function(t){var e=this.getBasis(t),r=this.quaternionToMatrix3(e);return this.freeQuaternion(e),r},getOrigin:function(t){return t.getOrigin()},setOrigin:function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},copyOrigin:function(t,e){var r=e.getOrigin();this.setOrigin(t,r)},setBasis:function(t,e){t.setRotation(e)},setBasisFromMatrix3:function(t,e){var r=this.matrix3ToQuaternion(e);this.setBasis(t,r),this.freeQuaternion(r)},setOriginFromArray3:function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},setBasisFromArray3:function(t,e){t.getBasis().setEulerZYX(e[0],e[1],e[2])},setBasisFromArray4:function(t,e){var r=this.array4ToQuaternion(e);this.setBasis(t,r),this.freeQuaternion(r)},array4ToQuaternion:function(t){var e=this.allocQuaternion();return e.setX(t[0]),e.setY(t[1]),e.setZ(t[2]),e.setW(t[3]),e},multiplyTransforms:function(t,e){var r=this.allocTransform();this.setIdentity(r);var i=this.getBasisAsMatrix3(t),o=this.getBasisAsMatrix3(e),s=this.getOrigin(t),n=this.getOrigin(e),a=this.multiplyMatrix3ByVector3(i,n),h=this.addVector3(a,s);this.setOrigin(r,h);var c=this.multiplyMatrices3(i,o);return this.setBasisFromMatrix3(r,c),this.freeVector3(a),this.freeVector3(h),r},inverseTransform:function(t){var e=this.allocTransform(),r=this.getBasisAsMatrix3(t),i=this.getOrigin(t),o=this.transposeMatrix3(r),s=this.negativeVector3(i),n=this.multiplyMatrix3ByVector3(o,s);return this.setOrigin(e,n),this.setBasisFromMatrix3(e,o),this.freeVector3(s),this.freeVector3(n),e},multiplyMatrices3:function(t,e){var r=[],i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.columnOfMatrix3(e,0),a=this.columnOfMatrix3(e,1),h=this.columnOfMatrix3(e,2);return r[0]=this.dotVectors3(i,n),r[1]=this.dotVectors3(i,a),r[2]=this.dotVectors3(i,h),r[3]=this.dotVectors3(o,n),r[4]=this.dotVectors3(o,a),r[5]=this.dotVectors3(o,h),r[6]=this.dotVectors3(s,n),r[7]=this.dotVectors3(s,a),r[8]=this.dotVectors3(s,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),this.freeVector3(n),this.freeVector3(a),this.freeVector3(h),r},addVector3:function(t,e){var r=this.allocVector3();return r.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),r},dotVectors3:function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},rowOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),r},columnOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[e+0],t[e+3],t[e+6]),r},negativeVector3:function(t){var e=this.allocVector3();return e.setValue(-t.x(),-t.y(),-t.z()),e},multiplyMatrix3ByVector3:function(t,e){var r=this.allocVector3(),i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.dotVectors3(i,e),a=this.dotVectors3(o,e),h=this.dotVectors3(s,e);return r.setValue(n,a,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),r},transposeMatrix3:function(t){var e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},quaternionToMatrix3:function(t){var e=[],r=t.x(),i=t.y(),o=t.z(),s=t.w(),n=r*r,a=i*i,h=o*o,c=r*i,f=i*o,u=o*r,l=r*s,m=i*s,d=o*s;return e[0]=1-2*(a+h),e[1]=2*(c-d),e[2]=2*(u+m),e[3]=2*(c+d),e[4]=1-2*(h+n),e[5]=2*(f-l),e[6]=2*(u-m),e[7]=2*(f+l),e[8]=1-2*(n+a),e},matrix3ToQuaternion:function(t){var e,r,i,o,s,n=t[0]+t[4]+t[8];n>0?(s=.25*(e=2*Math.sqrt(n+1)),r=(t[7]-t[5])/e,i=(t[2]-t[6])/e,o=(t[3]-t[1])/e):t[0]>t[4]&&t[0]>t[8]?(e=2*Math.sqrt(1+t[0]-t[4]-t[8]),s=(t[7]-t[5])/e,r=.25*e,i=(t[1]+t[3])/e,o=(t[2]+t[6])/e):t[4]>t[8]?(e=2*Math.sqrt(1+t[4]-t[0]-t[8]),s=(t[2]-t[6])/e,r=(t[1]+t[3])/e,i=.25*e,o=(t[5]+t[7])/e):(e=2*Math.sqrt(1+t[8]-t[0]-t[4]),s=(t[3]-t[1])/e,r=(t[2]+t[6])/e,i=(t[5]+t[7])/e,o=.25*e);var a=this.allocQuaternion();return a.setX(r),a.setY(i),a.setZ(o),a.setW(s),a}},THREE.MMDPhysics.RigidBody=function(t,e,r,i){this.mesh=t,this.world=e,this.params=r,this.helper=i,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this.init()},THREE.MMDPhysics.RigidBody.prototype={constructor:THREE.MMDPhysics.RigidBody,init:function(){var t=this.helper,e=this.params,r=this.mesh.skeleton.bones,i=-1===e.boneIndex?new THREE.Bone:r[e.boneIndex],o=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw"unknown shape type "+t.shapeType}}(e),s=0===e.type?0:e.weight,n=t.allocVector3();n.setValue(0,0,0),0!==s&&o.calculateLocalInertia(s,n);var a=t.allocTransform();t.setIdentity(a),t.setOriginFromArray3(a,e.position),t.setBasisFromArray3(a,e.rotation);var h=t.allocTransform();t.setIdentity(h),t.setOriginFromArray3(h,i.getWorldPosition().toArray());var c=t.multiplyTransforms(h,a),f=new Ammo.btDefaultMotionState(c),u=new Ammo.btRigidBodyConstructionInfo(s,f,o,n);u.set_m_friction(e.friction),u.set_m_restitution(e.restriction);var l=new Ammo.btRigidBody(u);0===e.type&&(l.setCollisionFlags(2|l.getCollisionFlags()),l.setActivationState(4)),l.setDamping(e.positionDamping,e.rotationDamping),l.setSleepingThresholds(0,0),this.world.addRigidBody(l,1<<e.groupIndex,e.groupTarget),this.body=l,this.bone=i,this.boneOffsetForm=a,this.boneOffsetFormInverse=t.inverseTransform(a),t.freeVector3(n),t.freeTransform(c),t.freeTransform(h)},reset:function(){this.setTransformFromBone()},updateFromBone:function(){-1!==this.params.boneIndex&&(0===this.params.type&&this.setTransformFromBone(),2===this.params.type&&this.setPositionFromBone())},updateBone:function(){0!==this.params.type&&-1!==this.params.boneIndex&&(this.updateBoneRotation(),1===this.params.type&&this.updateBonePosition(),this.bone.updateMatrixWorld(!0))},getBoneTransform:function(){var t=this.helper,e=this.bone.getWorldPosition(),r=this.bone.getWorldQuaternion(),i=t.allocTransform();t.setOriginFromArray3(i,e.toArray()),t.setBasisFromArray4(i,r.toArray());var o=t.multiplyTransforms(i,this.boneOffsetForm);return t.freeTransform(i),o},getWorldTransformForBone:function(){var t=this.helper,e=t.allocTransform();this.body.getMotionState().getWorldTransform(e);var r=t.multiplyTransforms(e,this.boneOffsetFormInverse);return t.freeTransform(e),r},setTransformFromBone:function(){var t=this.helper,e=this.getBoneTransform();this.body.setCenterOfMassTransform(e),this.body.getMotionState().setWorldTransform(e),t.freeTransform(e)},setPositionFromBone:function(){var t=this.helper,e=this.getBoneTransform(),r=t.allocTransform();this.body.getMotionState().getWorldTransform(r),t.copyOrigin(r,e),this.body.setCenterOfMassTransform(r),this.body.getMotionState().setWorldTransform(r),t.freeTransform(r),t.freeTransform(e)},updateBoneRotation:function(){this.bone.updateMatrixWorld(!0);var t=this.helper,e=this.getWorldTransformForBone(),r=t.getBasis(e),i=t.allocThreeQuaternion(),o=t.allocThreeQuaternion(),s=t.allocThreeQuaternion();i.set(r.x(),r.y(),r.z(),r.w()),o.setFromRotationMatrix(this.bone.matrixWorld),o.conjugate(),o.multiply(i),s.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(o.multiply(s)),t.freeThreeQuaternion(i),t.freeThreeQuaternion(o),t.freeThreeQuaternion(s),t.freeQuaternion(r),t.freeTransform(e)},updateBonePosition:function(){var t=this.helper,e=this.getWorldTransformForBone(),r=t.allocThreeVector3(),i=t.getOrigin(e);r.set(i.x(),i.y(),i.z());var o=this.bone.worldToLocal(r);this.bone.position.add(o),t.freeThreeVector3(r),t.freeTransform(e)}},THREE.MMDPhysics.Constraint=function(t,e,r,i,o,s){this.mesh=t,this.world=e,this.bodyA=r,this.bodyB=i,this.params=o,this.helper=s,this.constraint=null,this.init()},THREE.MMDPhysics.Constraint.prototype={constructor:THREE.MMDPhysics.Constraint,init:function(){var t=this.helper,e=this.params,r=this.bodyA,i=this.bodyB,o=t.allocTransform();t.setIdentity(o),t.setOriginFromArray3(o,e.position),t.setBasisFromArray3(o,e.rotation);var s=t.allocTransform(),n=t.allocTransform();r.body.getMotionState().getWorldTransform(s),i.body.getMotionState().getWorldTransform(n);var a=t.inverseTransform(s),h=t.inverseTransform(n),c=t.multiplyTransforms(a,o),f=t.multiplyTransforms(h,o),u=new Ammo.btGeneric6DofSpringConstraint(r.body,i.body,c,f,!0),l=t.allocVector3(),m=t.allocVector3(),d=t.allocVector3(),p=t.allocVector3();l.setValue(e.translationLimitation1[0],e.translationLimitation1[1],e.translationLimitation1[2]),m.setValue(e.translationLimitation2[0],e.translationLimitation2[1],e.translationLimitation2[2]),d.setValue(e.rotationLimitation1[0],e.rotationLimitation1[1],e.rotationLimitation1[2]),p.setValue(e.rotationLimitation2[0],e.rotationLimitation2[1],e.rotationLimitation2[2]),u.setLinearLowerLimit(l),u.setLinearUpperLimit(m),u.setAngularLowerLimit(d),u.setAngularUpperLimit(p);for(g=0;g<3;g++)0!==e.springPosition[g]&&(u.enableSpring(g,!0),u.setStiffness(g,e.springPosition[g]));for(var g=0;g<3;g++)0!==e.springRotation[g]&&(u.enableSpring(g+3,!0),u.setStiffness(g+3,e.springRotation[g]));this.world.addConstraint(u,!0),this.constraint=u,t.freeTransform(o),t.freeTransform(s),t.freeTransform(n),t.freeTransform(a),t.freeTransform(h),t.freeTransform(c),t.freeTransform(f),t.freeVector3(l),t.freeVector3(m),t.freeVector3(d),t.freeVector3(p)}};
//# sourceMappingURL=../../maps/threejs/animation/MMDPhysics.js.map
