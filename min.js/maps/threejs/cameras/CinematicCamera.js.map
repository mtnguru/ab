{"version":3,"sources":["threejs/cameras/CinematicCamera.js"],"names":["THREE","CinematicCamera","fov","aspect","near","far","PerspectiveCamera","call","this","type","postprocessing","enabled","shaderSettings","rings","samples","material_depth","MeshDepthMaterial","setLens","initPostProcessing","prototype","Object","create","constructor","focalLength","filmGauge","fNumber","coc","undefined","setFocalLength","aperture","hyperFocal","linearize","depth","zfar","znear","smoothstep","x","saturate","Math","max","min","focusAt","focusDistance","getFocalLength","focus","nearPoint","farPoint","depthOfField","sdistance","ldistance","bokeh_uniforms","value","scene","Scene","camera","OrthographicCamera","window","innerWidth","innerHeight","add","pars","minFilter","LinearFilter","magFilter","format","RGBFormat","rtTextureDepth","WebGLRenderTarget","rtTextureColor","bokeh_shader","BokehShader","UniformsUtils","clone","uniforms","texture","materialBokeh","ShaderMaterial","vertexShader","fragmentShader","defines","RINGS","SAMPLES","quad","Mesh","PlaneBufferGeometry","position","z","renderCinematic","renderer","clear","overrideMaterial","render"],"mappings":"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","file":"../../../threejs/cameras/CinematicCamera.js","sourcesContent":["/**\n * @author mrdoob / http://mrdoob.com/\n * @author greggman / http://games.greggman.com/\n * @author zz85 / http://www.lab4games.net/zz85/blog\n * @author kaypiKun\n */\n\nTHREE.CinematicCamera = function( fov, aspect, near, far ) {\n\n\tTHREE.PerspectiveCamera.call( this, fov, aspect, near, far );\n\n\tthis.type = \"CinematicCamera\";\n\n\tthis.postprocessing = { enabled\t: true };\n\tthis.shaderSettings = {\n\t\trings: 3,\n\t\tsamples: 4\n\t};\n\n\tthis.material_depth = new THREE.MeshDepthMaterial();\n\n\t// In case of cinematicCamera, having a default lens set is important\n\tthis.setLens();\n\n\tthis.initPostProcessing();\n\n};\n\nTHREE.CinematicCamera.prototype = Object.create( THREE.PerspectiveCamera.prototype );\nTHREE.CinematicCamera.prototype.constructor = THREE.CinematicCamera;\n\n\n// providing fnumber and coc(Circle of Confusion) as extra arguments\nTHREE.CinematicCamera.prototype.setLens = function ( focalLength, filmGauge, fNumber, coc ) {\n\n\t// In case of cinematicCamera, having a default lens set is important\n\tif ( focalLength === undefined ) focalLength = 35;\n\tif ( filmGauge !== undefined ) this.filmGauge = filmGauge;\n\n\tthis.setFocalLength( focalLength );\n\n\t// if fnumber and coc are not provided, cinematicCamera tries to act as a basic PerspectiveCamera\n\tif ( fNumber === undefined ) fNumber = 8;\n\tif ( coc === undefined ) coc = 0.019;\n\n\tthis.fNumber = fNumber;\n\tthis.coc = coc;\n\n\t// fNumber is focalLength by aperture\n\tthis.aperture = focalLength / this.fNumber;\n\n\t// hyperFocal is required to calculate depthOfField when a lens tries to focus at a distance with given fNumber and focalLength\n\tthis.hyperFocal = ( focalLength * focalLength ) / ( this.aperture * this.coc );\n\n};\n\nTHREE.CinematicCamera.prototype.linearize = function ( depth ) {\n\n\tvar zfar = this.far;\n\tvar znear = this.near;\n\treturn - zfar * znear / ( depth * ( zfar - znear ) - zfar );\n\n};\n\nTHREE.CinematicCamera.prototype.smoothstep = function ( near, far, depth ) {\n\n\tvar x = this.saturate( ( depth - near ) / ( far - near ) );\n\treturn x * x * ( 3 - 2 * x );\n\n};\n\nTHREE.CinematicCamera.prototype.saturate = function ( x ) {\n\n\treturn Math.max( 0, Math.min( 1, x ) );\n\n};\n\n// function for focusing at a distance from the camera\nTHREE.CinematicCamera.prototype.focusAt = function ( focusDistance ) {\n\n\tif ( focusDistance === undefined ) focusDistance = 20;\n\n\tvar focalLength = this.getFocalLength();\n\n\t// distance from the camera (normal to frustrum) to focus on\n\tthis.focus = focusDistance;\n\n\t// the nearest point from the camera which is in focus (unused)\n\tthis.nearPoint = ( this.hyperFocal * this.focus ) / ( this.hyperFocal + ( this.focus - focalLength ) );\n\n\t// the farthest point from the camera which is in focus (unused)\n\tthis.farPoint = ( this.hyperFocal * this.focus ) / ( this.hyperFocal - ( this.focus - focalLength ) );\n\n\t// the gap or width of the space in which is everything is in focus (unused)\n\tthis.depthOfField = this.farPoint - this.nearPoint;\n\n\t// Considering minimum distance of focus for a standard lens (unused)\n\tif ( this.depthOfField < 0 ) this.depthOfField = 0;\n\n\tthis.sdistance = this.smoothstep( this.near, this.far, this.focus );\n\n\tthis.ldistance = this.linearize( 1 -\tthis.sdistance );\n\n\tthis.postprocessing.bokeh_uniforms[ 'focalDepth' ].value = this.ldistance;\n\n};\n\nTHREE.CinematicCamera.prototype.initPostProcessing = function () {\n\n\tif ( this.postprocessing.enabled ) {\n\n\t\tthis.postprocessing.scene = new THREE.Scene();\n\n\t\tthis.postprocessing.camera = new THREE.OrthographicCamera( window.innerWidth / - 2, window.innerWidth / 2,\twindow.innerHeight / 2, window.innerHeight / - 2, - 10000, 10000 );\n\n\t\tthis.postprocessing.scene.add( this.postprocessing.camera );\n\n\t\tvar pars = { minFilter: THREE.LinearFilter, magFilter: THREE.LinearFilter, format: THREE.RGBFormat };\n\t\tthis.postprocessing.rtTextureDepth = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, pars );\n\t\tthis.postprocessing.rtTextureColor = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, pars );\n\n\t\tvar bokeh_shader = THREE.BokehShader;\n\n\t\tthis.postprocessing.bokeh_uniforms = THREE.UniformsUtils.clone( bokeh_shader.uniforms );\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"tColor\" ].value = this.postprocessing.rtTextureColor.texture;\n\t\tthis.postprocessing.bokeh_uniforms[ \"tDepth\" ].value = this.postprocessing.rtTextureDepth.texture;\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"manualdof\" ].value = 0;\n\t\tthis.postprocessing.bokeh_uniforms[ \"shaderFocus\" ].value = 0;\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"fstop\" ].value = 2.8;\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"showFocus\" ].value = 1;\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"focalDepth\" ].value = 0.1;\n\n\t\t//console.log( this.postprocessing.bokeh_uniforms[ \"focalDepth\" ].value );\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"znear\" ].value = this.near;\n\t\tthis.postprocessing.bokeh_uniforms[ \"zfar\" ].value = this.near;\n\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"textureWidth\" ].value = window.innerWidth;\n\n\t\tthis.postprocessing.bokeh_uniforms[ \"textureHeight\" ].value = window.innerHeight;\n\n\t\tthis.postprocessing.materialBokeh = new THREE.ShaderMaterial( {\n\t\t\tuniforms: this.postprocessing.bokeh_uniforms,\n\t\t\tvertexShader: bokeh_shader.vertexShader,\n\t\t\tfragmentShader: bokeh_shader.fragmentShader,\n\t\t\tdefines: {\n\t\t\t\tRINGS: this.shaderSettings.rings,\n\t\t\t\tSAMPLES: this.shaderSettings.samples\n\t\t\t}\n\t\t} );\n\n\t\tthis.postprocessing.quad = new THREE.Mesh( new THREE.PlaneBufferGeometry( window.innerWidth, window.innerHeight ), this.postprocessing.materialBokeh );\n\t\tthis.postprocessing.quad.position.z = - 500;\n\t\tthis.postprocessing.scene.add( this.postprocessing.quad );\n\n\t}\n\n};\n\nTHREE.CinematicCamera.prototype.renderCinematic = function ( scene, renderer ) {\n\n\tif ( this.postprocessing.enabled ) {\n\n\t\trenderer.clear();\n\n\t\t// Render scene into texture\n\n\t\tscene.overrideMaterial = null;\n\t\trenderer.render( scene, camera, this.postprocessing.rtTextureColor, true );\n\n\t\t// Render depth into texture\n\n\t\tscene.overrideMaterial = this.material_depth;\n\t\trenderer.render( scene, camera, this.postprocessing.rtTextureDepth, true );\n\n\t\t// Render bokeh composite\n\n\t\trenderer.render( this.postprocessing.scene, this.postprocessing.camera );\n\n\t}\n\n};\n"]}